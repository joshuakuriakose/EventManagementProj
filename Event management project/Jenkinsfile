pipeline {
    agent { label 'DESKTOP-PNDAH72' }

    environment {
        XAMPP_HTDOCS = 'C:\\xampp\\htdocs\\EventProject'  // Destination directory
        PROJECT_SOURCE = "${WORKSPACE}"  // Jenkins workspace
        PHP_PATH = 'C:\\xampp\\php\\php.exe'  // Full path to PHP
        APACHE_PATH = 'C:\\xampp\\apache\\bin\\httpd.exe'  // Full path to Apache
    }

    stages {
        stage('Checkout SCM') {
            steps {
                echo 'üì• Checking out source code from Git...'
                checkout scm
            }
        }

        stage('Start Apache Server') {
            steps {
                echo 'üöÄ Starting Apache Server if not already running...'
                bat '''
                tasklist /FI "IMAGENAME eq httpd.exe" | find /I "httpd.exe" >nul
                if errorlevel 1 (
                    echo Apache not running. Starting now...
                    "C:\\xampp\\apache\\bin\\httpd.exe"
                    timeout /T 5 >nul
                ) else (
                    echo Apache is already running.
                )
                '''
            }
        }

        stage('PHP Lint Check') {
            steps {
                echo 'üîç Running PHP lint check on project files...'
                bat '''
                for %%f in (%PROJECT_SOURCE%\\*.php) do (
                    "C:\\xampp\\php\\php.exe" -l "%%f" || exit /b 1
                )
                '''
            }
        }

        stage('Deploy to XAMPP') {
            steps {
                echo 'üìÇ Deploying website to XAMPP htdocs...'
                bat '''
                if exist "%XAMPP_HTDOCS%" (
                    echo Removing existing files...
                    rmdir /S /Q "%XAMPP_HTDOCS%"
                )
                mkdir "%XAMPP_HTDOCS%"
                xcopy /Y /E /I "%PROJECT_SOURCE%\\*" "%XAMPP_HTDOCS%\\"
                '''
            }
        }

        stage('Open Website in Browser') {
            steps {
                echo 'üåê Opening website in default browser...'
                bat 'start "" "http://localhost/EventProject"'
            }
        }
    }

    post {
        always {
            echo '‚úîÔ∏è Pipeline execution complete.'
        }
        success {
            echo '‚úÖ Build completed successfully!'
        }
        failure {
            echo '‚ùå Build failed!'
        }
    }
}
