pipeline {
    agent any

    environment {
        APACHE_PATH = 'C:\\xampp\\apache\\bin\\httpd.exe'
        XAMPP_HTDOCS = 'C:\\xampp\\htdocs\\event-management' // Deploy path
        PROJECT_SOURCE = "${env.WORKSPACE}\\Event Management Pipeline"
    }

    stages {
        stage('Start Apache Server') {
            steps {
                echo 'üöÄ Starting Apache Server...'
                bat '''
                echo Checking if Apache is already running...
                tasklist /FI "IMAGENAME eq httpd.exe" | find /I "httpd.exe"
                if errorlevel 1 (
                    echo Apache not running. Attempting to start...
                    "C:\\xampp\\apache\\bin\\httpd.exe"
                ) else (
                    echo Apache already running.
                )
                '''
            }
        }

        stage('Checkout Code') {
            steps {
                echo 'üì• Checking out code...'
                checkout scm
            }
        }

        stage('PHP Lint Check') {
            steps {
                echo 'üß™ Running PHP lint check...'
                bat '''
                FOR /R %%f IN (*.php) DO (
                    php -l "%%f"
                )
                '''
            }
        }

        stage('Deploy to XAMPP') {
            steps {
                echo 'üìÇ Deploying files to XAMPP htdocs...'
                bat """
                if exist "${XAMPP_HTDOCS}" (
                    rmdir /s /q "${XAMPP_HTDOCS}"
                )
                mkdir "${XAMPP_HTDOCS}"
                xcopy /E /I /Y "${WORKSPACE}\\*" "${XAMPP_HTDOCS}\\"
                """
            }
        }

        stage('Open in Browser') {
            steps {
                echo 'üåê Opening site in default browser...'
                bat 'start http://localhost/event-management'
            }
        }
    }

    post {
        success {
            echo '‚úÖ Build completed successfully!'
        }
        failure {
            echo '‚ùå Build failed!'
        }
    }
}
